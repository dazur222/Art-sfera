<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa Cultural | Artísfera</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-o88Awf/69bEakuxSCKLCnv1N+HdM+Y6RtKjvC3QfXjk="
    crossorigin=""
  />
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 0;
    }

    #map {
      height: 90vh;
      width: 100%;
    }

    .control {
      padding: 1rem;
      background: white;
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>

  <div class="control">
    <label for="radius">Radio (km):</label>
    <input type="number" id="radius" value="5" min="1" max="50" />
    <button onclick="updateMap()">Actualizar</button>
  </div>

  <div id="map"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j+1L1sptJR3C7EJm1UchcrghY0vFq0zFZs5yX6A="
    crossorigin=""
  ></script>

  <script>
    // Lugares de ejemplo
    const lugaresCulturales = [
      { nombre: "Museo de Arte Moderno", lat: 28.635, lng: -106.088 },
      { nombre: "Centro Cultural Quinta Gameros", lat: 28.6355, lng: -106.075 },
      { nombre: "Parque del Arte", lat: 28.645, lng: -106.08 },
      { nombre: "Teatro de la Ciudad", lat: 28.625, lng: -106.07 },
      { nombre: "Feria artesanal - Plaza Mayor", lat: 28.637, lng: -106.1 }
    ];

    let map, userMarker, circle;
    const markers = [];

    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371; // km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lng2 - lng1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function updateMap() {
      const radiusKm = parseFloat(document.getElementById('radius').value);
      if (circle) map.removeLayer(circle);
      markers.forEach(m => map.removeLayer(m));
      markers.length = 0;

      const userLatLng = userMarker.getLatLng();
      circle = L.circle(userLatLng, {
        radius: radiusKm * 1000,
        color: "#8C52FF",
        fillOpacity: 0.1
      }).addTo(map);

      lugaresCulturales.forEach(lugar => {
        const dist = getDistance(userLatLng.lat, userLatLng.lng, lugar.lat, lugar.lng);
        if (dist <= radiusKm) {
          const marker = L.marker([lugar.lat, lugar.lng])
            .addTo(map)
            .bindPopup(`<strong>${lugar.nombre}</strong><br>Distancia: ${dist.toFixed(2)} km`);
          markers.push(marker);
        }
      });
    }

    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;

      map = L.map('map').setView([latitude, longitude], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      userMarker = L.marker([latitude, longitude])
        .addTo(map)
        .bindPopup("Estás aquí")
        .openPopup();

      updateMap();

    }, err => {
      alert("No se pudo obtener tu ubicación.");
    });
  </script>

</body>
</html>
